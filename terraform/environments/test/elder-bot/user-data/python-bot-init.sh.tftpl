#!/bin/bash
set -e

LOG_FILE="/home/ubuntu/initialization.log"
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log_message "=== Python Bot Server Initialization Started ==="

# [1/6] 시스템 업데이트 및 기본 패키지 설치
log_message "[1/6] Updating system and installing base packages..."
export DEBIAN_FRONTEND=noninteractive
apt-get update -y
apt-get upgrade -y

# jw.sh에 있던 의존성들을 미리 설치 (속도 및 편의성)
apt-get install -y \
    curl wget vim unzip jq htop \
    build-essential ca-certificates gnupg lsb-release \
    rsync software-properties-common fzf tmux \
    ffmpeg libsm6 libxext6 libgl1 \
    python3 python3-pip python3-venv git

# [2/6] 시간대 설정
log_message "[2/6] Setting timezone to Asia/Seoul..."
timedatectl set-timezone Asia/Seoul

# [3/6] Docker 설치 (Ubuntu 24.04 권장 방식)
log_message "[3/6] Installing Docker..."
if ! command -v docker &> /dev/null; then
    install -m 0755 -d /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    chmod a+r /etc/apt/keyrings/docker.gpg

    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

    apt-get update -y
    apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

    systemctl start docker
    systemctl enable docker
    usermod -aG docker ubuntu
fi

# [4/6] GitHub CLI 설치
log_message "[4/6] Installing GitHub CLI..."
if ! command -v gh &> /dev/null; then
    mkdir -p -m 755 /etc/apt/keyrings
    wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg | tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null
    chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
    apt-get update -y
    apt-get install -y gh
fi

# [5/6] Python 심볼릭 링크 (시스템 pip 업그레이드는 생략)
if [ ! -e /usr/bin/python ]; then
    ln -s /usr/bin/python3 /usr/bin/python
fi

# [6/6] jw.sh 작성
cat << 'EOF' > /home/ubuntu/jw.sh
#!/bin/bash
# 이 스크립트는 ubuntu 사용자로 실행하는 것을 권장합니다.

PROJECT_DIR="/home/ubuntu/damso"
mkdir -p $PROJECT_DIR
cd $PROJECT_DIR

echo "Cloning repository..."
git clone https://github.com/Namanmoo-Damso/ops-bot.git
cd ops-bot

echo "Setting up virtual environment..."
python3 -m venv venv
source venv/bin/activate

# venv 내부에서 pip 업그레이드
pip install --upgrade pip

if [ -f "requirements.txt" ]; then
    echo "Installing Python dependencies..."
    pip install -r requirements.txt
else
    echo "Warning: requirements.txt not found."
fi

if [ -f "bot/.env.example" ]; then
    cp bot/.env.example bot/.env
    echo "Action Required: Please edit $PROJECT_DIR/ops-bot/bot/.env with your credentials."
fi

echo "Setup complete! Run: source venv/bin/activate && cd bot"
EOF

chmod +x /home/ubuntu/jw.sh
chown ubuntu:ubuntu /home/ubuntu/jw.sh

log_message "=== Initialization Completed ==="
chown ubuntu:ubuntu "$LOG_FILE"
