#!/bin/bash
# =============================================================================
# Python Bot Server 초기화 스크립트
# =============================================================================
# 1. 기본 시스템 설정 (Timezone, 필수 패키지)
# 2. Docker, Git, GitHub CLI, Rsync 설치
# 3. Python 환경 준비
# =============================================================================

set -e

LOG_FILE="/home/ubuntu/initialization.log"

# 로그 함수
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log_message "=== Python Bot Server Initialization Started ==="

# -----------------------------------------------------------------------------
# 1. 시스템 업데이트 및 기본 패키지 설치
# -----------------------------------------------------------------------------
log_message "[1/6] Updating system and installing base packages..."
export DEBIAN_FRONTEND=noninteractive
apt-get update -y
apt-get upgrade -y
apt-get install -y \
    curl wget vim unzip jq htop \
    build-essential ca-certificates gnupg lsb-release \
    rsync software-properties-common

# -----------------------------------------------------------------------------
# 2. 시간대 설정 (Asia/Seoul)
# -----------------------------------------------------------------------------
log_message "[2/6] Setting timezone to Asia/Seoul..."
timedatectl set-timezone Asia/Seoul

# -----------------------------------------------------------------------------
# 3. Docker 설치
# -----------------------------------------------------------------------------
log_message "[3/6] Installing Docker..."
if ! command -v docker &> /dev/null; then
    install -m 0755 -d /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
    chmod a+r /etc/apt/keyrings/docker.asc

    echo \
        "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
      $(. /etc/os-release && echo "$VERSION_CODENAME") stable" \
                                                               | tee /etc/apt/sources.list.d/docker.list > /dev/null

    apt-get update -y
    apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

    systemctl start docker
    systemctl enable docker
    usermod -aG docker ubuntu
fi

# -----------------------------------------------------------------------------
# 4. Git 설치
# -----------------------------------------------------------------------------
log_message "[4/6] Installing Git..."
apt-get install -y git

# -----------------------------------------------------------------------------
# 5. GitHub CLI 설치
# -----------------------------------------------------------------------------
log_message "[5/6] Installing GitHub CLI..."
if ! command -v gh &> /dev/null; then
    # GitHub CLI 공식 APT 저장소 추가
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
    chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null

    apt-get update -y
    apt-get install -y gh
fi

# -----------------------------------------------------------------------------
# 6. Python 환경 준비
# -----------------------------------------------------------------------------
log_message "[6/6] Setting up Python environment..."
apt-get install -y python3 python3-pip python3-venv

# Python 심볼릭 링크 설정
if [ ! -e /usr/bin/python ]; then
    ln -s /usr/bin/python3 /usr/bin/python
fi

# pip 업그레이드
python3 -m pip install --upgrade pip

# 프로젝트 디렉토리 생성
mkdir -p /home/ubuntu/ops-bot
chown -R ubuntu:ubuntu /home/ubuntu/ops-bot

# -----------------------------------------------------------------------------
# 완료
# -----------------------------------------------------------------------------
log_message "=== Python Bot Server Initialization Completed ==="
log_message "Installed packages:"
log_message "  - Docker: $(docker --version)"
log_message "  - Git: $(git --version)"
log_message "  - GitHub CLI: $(gh --version | head -1)"
log_message "  - Rsync: $(rsync --version | head -1)"
log_message "  - Python: $(python3 --version)"
log_message "  - Pip: $(pip3 --version)"

chown ubuntu:ubuntu "$LOG_FILE"
touch /tmp/init-complete
